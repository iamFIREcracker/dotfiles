#!/usr/bin/env bash

REMOTE_PORT=5556
REMOTE_PASTE_REQUEST_TOKEN=AKDJF8U4389HSDHF3H9RH39FJSKDHFJH983QR98HAUFHA

function copy() {
    if env | grep --quiet -F SSH_TTY; then
        nc localhost $REMOTE_PORT
    elif [ -e /dev/clipboard ]; then
        putclip
    else
        pbcopy
    fi
}

function paste() {
    if env | grep --quiet -F SSH_TTY; then
        echo -n $REMOTE_PASTE_REQUEST_TOKEN | nc localhost $REMOTE_PORT
    elif [ -e /dev/clipboard ]; then
        getclip
    else
        pbpaste
    fi
}

function listen() {
    echo "Listening on port $REMOTE_PORT..."
    while (true); do
        python <<END
import socket, subprocess

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
s.bind(('localhost', $REMOTE_PORT))
s.listen(1)
remote, _ = s.accept()
input = ''
while True:
    data = remote.recv(1024)
    if not data:
        break
    input += data
if input == '$REMOTE_PASTE_REQUEST_TOKEN':
    clipboard = subprocess.check_output(['$0',  '--force-paste'])
    remote.sendall(clipboard)
    print 'Pasted'
    print clipboard
else:
    process = subprocess.Popen(['$0'], stdin=subprocess.PIPE)
    process.communicate(input)
    process.poll()
    print 'Copied'
    print input
remote.close()
s.close()
END
        if [ $? -ne 0 ]; then
            break
        fi
    done
}

if [ "$1" = "--force-paste" ]; then
    paste
elif [ "$1" = "--listen" ]; then
    listen
else
    test -t 0 && paste || copy
fi
