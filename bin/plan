#!/usr/bin/env bash -e

EDITOR=${EDITOR?Need EDITOR set}
PLAN=${PLAN:-~/.plan}

if hash gsed 2>/dev/null; then
    _SED=gsed
elif hash sed 2>/dev/null; then
    _SED=$(which sed)
fi

function sed() {
    "$_SED" "$@"
}

function cat_plan_content() {
    sed -n '/^=/,$p' "$PLAN"
}

function help() {
    cat <<EOF
usage: plan [-h]
            {completed,discarded,open,cat}

Edit and filter .plan file.

positional arguments:
{completed,discarded,open,cat}

optional argument:
-h, --help               show this help message and exit
EOF
}

if [ $# -eq 0 ]; then
    $EDITOR "$PLAN"
fi

for i; do
    if [ "$i" == "--help" ]; then
        help
    elif [ "$i" == "-h" ]; then
        help
    elif [ "$i" == "completed" ]; then
        cat_plan_content | grep '^[*+]'
    elif [ "$i" == "discarded" ]; then
        cat_plan_content | grep '^#'
    elif [ "$i" == "open" ]; then
        cat_plan_content | grep '^\?'
    elif [ "$i" == "cat" ]; then
        cat "$PLAN"
    else
        exit -1
    fi
done
